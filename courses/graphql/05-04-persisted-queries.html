<!DOCTYPE html>
<html lang="en">
<head>
    <title> Persisted Queries </title>
        
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="index, nofollow, noarchive">
    
    <link rel="alternate" href="https://campusempresa.com/cursos/graphql/05-04-persisted-queries" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/cursos/graphql/05-04-persisted-queries" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/courses/graphql/05-04-persisted-queries" hreflang="en" />
    
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.ea63f62b9e.css" rel="stylesheet">
	 
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="/js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script>
  		var LANG = "en";
  		var CATEGORY = "frameworks";
  		var MOD_NAME = "graphql";
  		var TEMA_NAME = "5-4";
  		var TYPE = "mod";
  		var PATH = "mod/graphql/05-04-persisted-queries";
  		var IS_INDEX = false;
  	</script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="module" src="/js/app.902a5a267d.js"></script>
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0611338592562725" crossorigin="anonymous"></script>
	  	
</head>

<body class="d-none">
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-6 p-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo-header_enterprise.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-6 p-0 text-end">
			<p class="mb-0 p-0">	<b id="lit_lang_es" class="px-2">EN</b>
	|
	<a href="https://campusempresa.com/cursos/graphql/05-04-persisted-queries" class="px-2">ES</a></b>
	|
	<a href="https://campusempresa.cat/cursos/graphql/05-04-persisted-queries" class="px-2">CA</a>
</p>
			<p class="mb-4 mt-0 mx-2  d-none d-md-block"><cite>All the knowledge within your reach</cite></p>
		</div>
	</div>
</div>
<div class="subheader container-xxl d-none d-md-block">
	<div class="row">
		<div class="col-12 p-2 p-md-0 m-0 text-end">
			<a href="/objective" rel="nofollow">The Project</a> | 
<a href="/about" rel="nofollow">About Us</a> | 
<a href="/contribute" rel="nofollow">Contribute</a> | 
<a href="/donate" rel="nofollow">Donations</a> | 
<a href="/license" rel="nofollow">License</a>
		</div>
	</div>
</div>
		<div class="top-bar container-fluid p-0">
	<div class="container-xxl p-0">
		<div class="row">
			<div class="col">
				<div class="d-flex justify-content-between">
					<div class="left">
						<a href="/" class="nav-link px-3" id="btnHome">
	<i class="bi bi-house-fill"></i>
	HOME
</a>

<a href="/my-courses" class="nav-link px-3 d-none" id="btnMyCourses">
	<i class="bi bi-rocket-takeoff-fill"></i>
	<i><b>My courses</b></i>
</a>
<a href="/completed-courses" class="nav-link px-3 d-none" id="trophy_button">
	<i class="bi bi-trophy-fill"></i>
	Completed             
</a>

					</div>
                    <div class="ms-auto right">
                        <a id="user_button" href="#" class="nav-link px-3" data-bs-toggle="modal" data-bs-target="#loginModal">
                            <i id="user_icon" class="bi"></i>                            
                        </a>
                    </div>					
				</div>
			</div>
		</div>
	</div>
</div>

		<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
										<div class="row py-1 m-0" id="buttonsModSection">
	<div class="col-6 p-0" data-mod="graphql">
		<a  href="#" class="text-secondary d-none" data-read-mod="graphql" data-read-unit="5-4" style="text-decoration:none;">
			<i class="bi bi-check-circle-fill"></i> 
			Mark as read
		</a>
		<a href="#" class="text-secondary d-none" data-unread-mod="graphql" data-unread-unit="5-4" style="text-decoration:none;">
			<i class="bi bi-x-circle-fill"></i>
			Mark as unread
		</a>
	</div>
	<div class="col-6 text-end p-0">
					<a href="./"  class="nav-link">
				<i class="bi bi-journal-text"></i>
				Course Content
			</a>
			</div>
</div>						<div id="inner_content">
				<div class='row navigation'>
	<div class='col-2 d-none d-md-block'>
					<a href='05-03-authentication-authorization' title="Authentication and Authorization" class="py-2 px-3 btn btn-primary">
				&#x25C4; Previous 
			</a>
			</div>
	<div class='col-2 d-md-none'>
					<a href='05-03-authentication-authorization' title="Authentication and Authorization" class="py-2 px-3 btn btn-primary">
				&#x25C4;
			</a>
			</div>
	<div class='col-8 text-center'>
					<h2 style="text-decoration:underline">Persisted Queries</h2>
			</div>
	<div class='col-2 text-end d-none d-md-block'>
					<a href='06-01-graphiql-playground' title="GraphiQL and Playground" class="py-2 px-3 btn btn-primary"
				data-read-mod="graphql" data-read-unit="5-4">
				Next &#x25BA;
			</a>
			</div>
	<div class='col-2 text-end d-md-none '>
					<a href='06-01-graphiql-playground' title="GraphiQL and Playground" class="py-2 px-3 btn btn-primary" 
				data-read-mod="graphql" data-read-unit="5-4">
				 &#x25BA;
			</a>
			</div>
</div>
<div class='content'><p>Persisted queries are a powerful feature in GraphQL that can help improve performance and security by predefining and storing queries on the server. This approach can reduce the payload size, minimize the risk of malicious queries, and optimize the execution of frequently used queries.</p>
</div><h1>What are Persisted Queries?</h1>
<div class='content'><p>Persisted queries involve storing GraphQL queries on the server and referencing them by a unique identifier (ID) when making a request. Instead of sending the entire query string with each request, the client sends the ID of the persisted query, and the server retrieves and executes the corresponding query.</p>
</div><h2>Benefits of Persisted Queries</h2>
<div class='content'><ol>
<li><strong>Reduced Payload Size</strong>: By sending only the query ID, the payload size is significantly reduced, which can improve network performance.</li>
<li><strong>Enhanced Security</strong>: Since the queries are predefined and stored on the server, it reduces the risk of executing malicious or overly complex queries.</li>
<li><strong>Improved Performance</strong>: Frequently used queries can be optimized and cached on the server, leading to faster execution times.</li>
</ol>
</div><h1>Setting Up Persisted Queries</h1>
<div class='content'></div><h2>Step 1: Define and Store Queries</h2>
<div class='content'><p>First, define the queries you want to persist and store them on the server. This can be done using a simple key-value store where the key is the query ID and the value is the query string.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgcGVyc2lzdGVkUXVlcmllcyA9IHsKICAiZ2V0VXNlciI6IGAKICAgIHF1ZXJ5IGdldFVzZXIoJGlkOiBJRCEpIHsKICAgICAgdXNlcihpZDogJGlkKSB7CiAgICAgICAgaWQKICAgICAgICBuYW1lCiAgICAgICAgZW1haWwKICAgICAgfQogICAgfQogIGAsCiAgImdldFBvc3RzIjogYAogICAgcXVlcnkgZ2V0UG9zdHMgewogICAgICBwb3N0cyB7CiAgICAgICAgaWQKICAgICAgICB0aXRsZQogICAgICAgIGNvbnRlbnQKICAgICAgfQogICAgfQogIGAKfTs="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const persistedQueries = {
  &quot;getUser&quot;: `
    query getUser($id: ID!) {
      user(id: $id) {
        id
        name
        email
      }
    }
  `,
  &quot;getPosts&quot;: `
    query getPosts {
      posts {
        id
        title
        content
      }
    }
  `
};</pre></div><div class='content'></div><h2>Step 2: Implement a Middleware to Handle Persisted Queries</h2>
<div class='content'><p>Create a middleware function to intercept incoming requests and replace the query ID with the actual query string.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTsKY29uc3QgeyBncmFwaHFsSFRUUCB9ID0gcmVxdWlyZSgnZXhwcmVzcy1ncmFwaHFsJyk7CmNvbnN0IHsgYnVpbGRTY2hlbWEgfSA9IHJlcXVpcmUoJ2dyYXBocWwnKTsKCmNvbnN0IGFwcCA9IGV4cHJlc3MoKTsKCmFwcC51c2UoJy9ncmFwaHFsJywgKHJlcSwgcmVzLCBuZXh0KSA9PiB7CiAgY29uc3QgcXVlcnlJZCA9IHJlcS5ib2R5LnF1ZXJ5SWQ7CiAgaWYgKHF1ZXJ5SWQgJiYgcGVyc2lzdGVkUXVlcmllc1txdWVyeUlkXSkgewogICAgcmVxLmJvZHkucXVlcnkgPSBwZXJzaXN0ZWRRdWVyaWVzW3F1ZXJ5SWRdOwogIH0KICBuZXh0KCk7Cn0pOwoKY29uc3Qgc2NoZW1hID0gYnVpbGRTY2hlbWEoYAogIHR5cGUgVXNlciB7CiAgICBpZDogSUQhCiAgICBuYW1lOiBTdHJpbmchCiAgICBlbWFpbDogU3RyaW5nIQogIH0KCiAgdHlwZSBQb3N0IHsKICAgIGlkOiBJRCEKICAgIHRpdGxlOiBTdHJpbmchCiAgICBjb250ZW50OiBTdHJpbmchCiAgfQoKICB0eXBlIFF1ZXJ5IHsKICAgIHVzZXIoaWQ6IElEISk6IFVzZXIKICAgIHBvc3RzOiBbUG9zdF0KICB9CmApOwoKY29uc3Qgcm9vdCA9IHsKICB1c2VyOiAoeyBpZCB9KSA9PiB7CiAgICAvLyBGZXRjaCB1c2VyIGJ5IElECiAgfSwKICBwb3N0czogKCkgPT4gewogICAgLy8gRmV0Y2ggYWxsIHBvc3RzCiAgfQp9OwoKYXBwLnVzZSgnL2dyYXBocWwnLCBncmFwaHFsSFRUUCh7CiAgc2NoZW1hOiBzY2hlbWEsCiAgcm9vdFZhbHVlOiByb290LAogIGdyYXBoaXFsOiB0cnVlLAp9KSk7CgphcHAubGlzdGVuKDQwMDAsICgpID0+IGNvbnNvbGUubG9nKCdTZXJ2ZXIgcnVubmluZyBvbiBodHRwOi8vbG9jYWxob3N0OjQwMDAvZ3JhcGhxbCcpKTs="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const express = require('express');
const { graphqlHTTP } = require('express-graphql');
const { buildSchema } = require('graphql');

const app = express();

app.use('/graphql', (req, res, next) =&gt; {
  const queryId = req.body.queryId;
  if (queryId &amp;&amp; persistedQueries[queryId]) {
    req.body.query = persistedQueries[queryId];
  }
  next();
});

const schema = buildSchema(`
  type User {
    id: ID!
    name: String!
    email: String!
  }

  type Post {
    id: ID!
    title: String!
    content: String!
  }

  type Query {
    user(id: ID!): User
    posts: [Post]
  }
`);

const root = {
  user: ({ id }) =&gt; {
    // Fetch user by ID
  },
  posts: () =&gt; {
    // Fetch all posts
  }
};

app.use('/graphql', graphqlHTTP({
  schema: schema,
  rootValue: root,
  graphiql: true,
}));

app.listen(4000, () =&gt; console.log('Server running on http://localhost:4000/graphql'));</pre></div><div class='content'></div><h2>Step 3: Client-Side Implementation</h2>
<div class='content'><p>On the client side, instead of sending the entire query string, send the query ID and any necessary variables.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgZmV0Y2hQZXJzaXN0ZWRRdWVyeSA9IGFzeW5jIChxdWVyeUlkLCB2YXJpYWJsZXMpID0+IHsKICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKCdodHRwOi8vbG9jYWxob3N0OjQwMDAvZ3JhcGhxbCcsIHsKICAgIG1ldGhvZDogJ1BPU1QnLAogICAgaGVhZGVyczogewogICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nCiAgICB9LAogICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICBxdWVyeUlkOiBxdWVyeUlkLAogICAgICB2YXJpYWJsZXM6IHZhcmlhYmxlcwogICAgfSkKICB9KTsKICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogIHJldHVybiBkYXRhOwp9OwoKLy8gRXhhbXBsZSB1c2FnZQpmZXRjaFBlcnNpc3RlZFF1ZXJ5KCdnZXRVc2VyJywgeyBpZDogJzEnIH0pLnRoZW4oZGF0YSA9PiBjb25zb2xlLmxvZyhkYXRhKSk7"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const fetchPersistedQuery = async (queryId, variables) =&gt; {
  const response = await fetch('http://localhost:4000/graphql', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      queryId: queryId,
      variables: variables
    })
  });
  const data = await response.json();
  return data;
};

// Example usage
fetchPersistedQuery('getUser', { id: '1' }).then(data =&gt; console.log(data));</pre></div><div class='content'></div><h1>Practical Exercise</h1>
<div class='content'></div><h2>Exercise: Implement Persisted Queries</h2>
<div class='content'><ol>
<li><strong>Define a new persisted query</strong>: Add a new query to the <code>persistedQueries</code> object that fetches a list of comments.</li>
<li><strong>Update the middleware</strong>: Ensure the middleware can handle the new query.</li>
<li><strong>Test the new query</strong>: Use the client-side implementation to fetch the list of comments using the query ID.</li>
</ol>
</div><h2>Solution</h2>
<div class='content'><ol>
<li><strong>Define a new persisted query</strong>:</li>
</ol>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgcGVyc2lzdGVkUXVlcmllcyA9IHsKICAiZ2V0VXNlciI6IGAKICAgIHF1ZXJ5IGdldFVzZXIoJGlkOiBJRCEpIHsKICAgICAgdXNlcihpZDogJGlkKSB7CiAgICAgICAgaWQKICAgICAgICBuYW1lCiAgICAgICAgZW1haWwKICAgICAgfQogICAgfQogIGAsCiAgImdldFBvc3RzIjogYAogICAgcXVlcnkgZ2V0UG9zdHMgewogICAgICBwb3N0cyB7CiAgICAgICAgaWQKICAgICAgICB0aXRsZQogICAgICAgIGNvbnRlbnQKICAgICAgfQogICAgfQogIGAsCiAgImdldENvbW1lbnRzIjogYAogICAgcXVlcnkgZ2V0Q29tbWVudHMgewogICAgICBjb21tZW50cyB7CiAgICAgICAgaWQKICAgICAgICB0ZXh0CiAgICAgICAgYXV0aG9yIHsKICAgICAgICAgIGlkCiAgICAgICAgICBuYW1lCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgYAp9Ow=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const persistedQueries = {
  &quot;getUser&quot;: `
    query getUser($id: ID!) {
      user(id: $id) {
        id
        name
        email
      }
    }
  `,
  &quot;getPosts&quot;: `
    query getPosts {
      posts {
        id
        title
        content
      }
    }
  `,
  &quot;getComments&quot;: `
    query getComments {
      comments {
        id
        text
        author {
          id
          name
        }
      }
    }
  `
};</pre></div><div class='content'><ol start="2">
<li>
<p><strong>Update the middleware</strong>: The middleware already handles any query ID, so no changes are needed.</p>
</li>
<li>
<p><strong>Test the new query</strong>:</p>
</li>
</ol>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZmV0Y2hQZXJzaXN0ZWRRdWVyeSgnZ2V0Q29tbWVudHMnKS50aGVuKGRhdGEgPT4gY29uc29sZS5sb2coZGF0YSkpOw=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>fetchPersistedQuery('getComments').then(data =&gt; console.log(data));</pre></div><div class='content'></div><h1>Conclusion</h1>
<div class='content'><p>Persisted queries are a valuable tool for optimizing GraphQL applications. By reducing payload sizes, enhancing security, and improving performance, they can significantly improve the efficiency and reliability of your GraphQL server. In this section, you learned how to set up and implement persisted queries, both on the server and client sides. In the next module, we will explore various tools and the GraphQL ecosystem to further enhance your development experience.</p>
</div><div class='row navigation'>
	<div class='col-2 d-none d-md-block'>
					<a href='05-03-authentication-authorization' title="Authentication and Authorization" class="py-2 px-3 btn btn-primary">
				&#x25C4; Previous 
			</a>
			</div>
	<div class='col-2 d-md-none'>
					<a href='05-03-authentication-authorization' title="Authentication and Authorization" class="py-2 px-3 btn btn-primary">
				&#x25C4;
			</a>
			</div>
	<div class='col-8 text-center'>
			</div>
	<div class='col-2 text-end d-none d-md-block'>
					<a href='06-01-graphiql-playground' title="GraphiQL and Playground" class="py-2 px-3 btn btn-primary"
				data-read-mod="graphql" data-read-unit="5-4">
				Next &#x25BA;
			</a>
			</div>
	<div class='col-2 text-end d-md-none '>
					<a href='06-01-graphiql-playground' title="GraphiQL and Playground" class="py-2 px-3 btn btn-primary" 
				data-read-mod="graphql" data-read-unit="5-4">
				 &#x25BA;
			</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
						
	<div class="container mt-2 d-none d-md-block index">
		<h1>GraphQL Course</h1>
<h2>Module 1: Introduction to GraphQL</h2>
<ul>
<li><a href="01-01-what-is-graphql">What is GraphQL?</a></li>
<li><a href="01-02-graphql-vs-rest">GraphQL vs REST</a></li>
<li><a href="01-03-setting-up-graphql-server">Setting Up a GraphQL Server</a></li>
<li><a href="01-04-graphql-schema-basics">GraphQL Schema Basics</a></li>
</ul>
<h2>Module 2: Core Concepts</h2>
<ul>
<li><a href="02-01-queries">Queries</a></li>
<li><a href="02-02-mutations">Mutations</a></li>
<li><a href="02-03-resolvers">Resolvers</a></li>
<li><a href="02-04-graphql-types">GraphQL Types</a></li>
<li><a href="02-05-graphql-scalars">GraphQL Scalars</a></li>
</ul>
<h2>Module 3: Advanced Schema Design</h2>
<ul>
<li><a href="03-01-interfaces">Interfaces</a></li>
<li><a href="03-02-unions">Unions</a></li>
<li><a href="03-03-enums">Enums</a></li>
<li><a href="03-04-input-types">Input Types</a></li>
<li><a href="03-05-custom-scalars">Custom Scalars</a></li>
</ul>
<h2>Module 4: Working with Data</h2>
<ul>
<li><a href="04-01-connecting-to-database">Connecting to a Database</a></li>
<li><a href="04-02-data-fetching-strategies">Data Fetching Strategies</a></li>
<li><a href="04-03-batching-and-caching">Batching and Caching</a></li>
<li><a href="04-04-error-handling">Error Handling</a></li>
</ul>
<h2>Module 5: Performance and Security</h2>
<ul>
<li><a href="05-01-query-optimization">Query Optimization</a></li>
<li><a href="05-02-rate-limiting">Rate Limiting</a></li>
<li><a href="05-03-authentication-authorization">Authentication and Authorization</a></li>
<li><a href="05-04-persisted-queries">Persisted Queries</a></li>
</ul>
<h2>Module 6: Tooling and Ecosystem</h2>
<ul>
<li><a href="06-01-graphiql-playground">GraphiQL and Playground</a></li>
<li><a href="06-02-apollo-client">Apollo Client</a></li>
<li><a href="06-03-relay">Relay</a></li>
<li><a href="06-04-graphql-subscriptions">GraphQL Subscriptions</a></li>
</ul>
<h2>Module 7: Testing and Deployment</h2>
<ul>
<li><a href="07-01-unit-testing-resolvers">Unit Testing Resolvers</a></li>
<li><a href="07-02-integration-testing">Integration Testing</a></li>
<li><a href="07-03-continuous-integration">Continuous Integration</a></li>
<li><a href="07-04-deploying-graphql-servers">Deploying GraphQL Servers</a></li>
</ul>
<h2>Module 8: Real-world Applications</h2>
<ul>
<li><a href="08-01-building-fullstack-application">Building a Full-stack Application</a></li>
<li><a href="08-02-graphql-in-microservices">GraphQL in Microservices</a></li>
<li><a href="08-03-graphql-federation">GraphQL Federation</a></li>
<li><a href="08-04-case-studies">Case Studies</a></li>
</ul>

	</div>










		</div>
	</div>
</div>		
<div class="container-xxl d-block d-md-none">
	<div class="row">
		<div class="col-12 p-2 p-md-0 m-0 text-end">
			<a href="/objective" rel="nofollow">The Project</a> | 
<a href="/about" rel="nofollow">About Us</a> | 
<a href="/contribute" rel="nofollow">Contribute</a> | 
<a href="/donate" rel="nofollow">Donations</a> | 
<a href="/license" rel="nofollow">License</a>
		</div>
	</div>
</div>

<div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. All rights reserved</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	We use cookies to improve your user experience and offer content tailored to your interests.
    <a href="#" id="btn_accept_cookies" class="button">Accept</a>
    <a href="/cookies">More Information</a>
</div>	

		<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loginModalLabel">User not authenticated</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            	<div id="modal-body-main"></div>
            </div>
        </div>
    </div>
</div>	</div>    
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>
</html>
