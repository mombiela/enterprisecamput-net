<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middleware</title>

    <link rel="alternate" href="https://campusempresa.com/mod/nodejs/06-03-middleware" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/nodejs/06-03-middleware" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/nodejs/06-03-middleware" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="/js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body >
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-6 p-2 p-md-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo-header_enterprise.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-6 p-2 p-md-0 text-end">
				<b id="lit_lang_es" class="px-2">EN</b>
	|
	<a href="https://campusempresa.com/mod/nodejs/06-03-middleware" class="px-2">ES</a></b>
	|
	<a href="https://campusempresa.cat/mod/nodejs/06-03-middleware" class="px-2">CA</a>
<br>
			<cite>Building today's and tomorrow's society</cite>
		</div>
	</div>
</div>
<div id="subheader" class="container-xxl">
	<div class="row">
		<div class="col-12 p-2 p-md-0 m-0 text-end">
			<a href="/objective">The Project</a> | 
<a href="/about">About Us</a> | 
<a href="/contribute">Contribute</a> | 
<a href="/donate">Donations</a> | 
<a href="/licence">License</a>
		</div>
	</div>
</div>

<div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				 					<a href="/categ/languages">Programming Languages</a>
				 					<a href="/categ/frameworks">Frameworks and Libraries</a>
				 					<a href="/categ/tech-tools">Technical Tools</a>
				 					<a href="/categ/foundations">Theoretical Foundations</a>
				 					<a href="/categ/soft-skills">Social Skills</a>
							</div>
		</div>
	</div>
</div>
		
<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content">
				<div class='row navigation'>
	<div class='col-1 col-md-2'>
					<a href='06-02-setting-up-express' title="Setting Up an Express Application">
				<span class="d-none d-md-inline">&#x25C4; Previous</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-left-square-fill"></i></span>
			</a>
			</div>
	<div class='col-10 col-md-8 text-center'>
					<a href="./"><h2 style="text-decoration:underline">Middleware</h2></a>
			</div>
	<div class='col-1 col-md-2 text-end'>
					<a href='06-04-routing-express' title="Routing in Express">
				<span class="d-none d-md-inline">Next &#x25BA;</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-right-square-fill"></i></span>
			</a>
			</div>
</div>
<div class='content'><p>Middleware functions are an essential part of the Express.js framework. They are functions that have access to the request object (<code>req</code>), the response object (<code>res</code>), and the next middleware function in the application’s request-response cycle. Middleware can execute any code, make changes to the request and response objects, end the request-response cycle, and call the next middleware function in the stack.</p>
</div><h1><p>Key Concepts</p>
</h1>
<div class='content'><ol>
<li><strong>Definition</strong>: Middleware functions are functions that have access to the request object (<code>req</code>), the response object (<code>res</code>), and the next middleware function in the application’s request-response cycle.</li>
<li><strong>Execution Order</strong>: Middleware functions are executed sequentially, in the order they are defined.</li>
<li><strong>Types of Middleware</strong>:
<ul>
<li><strong>Application-level middleware</strong>: Bound to an instance of <code>express</code>.</li>
<li><strong>Router-level middleware</strong>: Bound to an instance of <code>express.Router()</code>.</li>
<li><strong>Error-handling middleware</strong>: Defined with four arguments instead of three.</li>
<li><strong>Built-in middleware</strong>: Provided by Express, such as <code>express.static</code>.</li>
<li><strong>Third-party middleware</strong>: Created by the community, such as <code>body-parser</code>.</li>
</ul>
</li>
</ol>
</div><h1><p>Practical Examples</p>
</h1>
<div class='content'></div><h2><p>Example 1: Application-Level Middleware</p>
</h2>
<div class='content'><p>Application-level middleware is bound to an instance of <code>express</code> using <code>app.use()</code> or <code>app.METHOD()</code>.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTsKY29uc3QgYXBwID0gZXhwcmVzcygpOwoKLy8gTWlkZGxld2FyZSBmdW5jdGlvbiB0byBsb2cgcmVxdWVzdCBkZXRhaWxzCmFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7CiAgY29uc29sZS5sb2coYCR7cmVxLm1ldGhvZH0gJHtyZXEudXJsfWApOwogIG5leHQoKTsgLy8gUGFzcyBjb250cm9sIHRvIHRoZSBuZXh0IG1pZGRsZXdhcmUgZnVuY3Rpb24KfSk7CgphcHAuZ2V0KCcvJywgKHJlcSwgcmVzKSA9PiB7CiAgcmVzLnNlbmQoJ0hlbGxvLCBXb3JsZCEnKTsKfSk7CgphcHAubGlzdGVuKDMwMDAsICgpID0+IHsKICBjb25zb2xlLmxvZygnU2VydmVyIGlzIHJ1bm5pbmcgb24gcG9ydCAzMDAwJyk7Cn0pOw=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const express = require('express');
const app = express();

// Middleware function to log request details
app.use((req, res, next) =&gt; {
  console.log(`${req.method} ${req.url}`);
  next(); // Pass control to the next middleware function
});

app.get('/', (req, res) =&gt; {
  res.send('Hello, World!');
});

app.listen(3000, () =&gt; {
  console.log('Server is running on port 3000');
});</pre></div><div class='content'><p><strong>Explanation</strong>:</p>
<ul>
<li>The middleware function logs the HTTP method and URL of each request.</li>
<li>The <code>next()</code> function is called to pass control to the next middleware function.</li>
</ul>
</div><h2><p>Example 2: Router-Level Middleware</p>
</h2>
<div class='content'><p>Router-level middleware works in the same way as application-level middleware, except it is bound to an instance of <code>express.Router()</code>.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTsKY29uc3QgYXBwID0gZXhwcmVzcygpOwpjb25zdCByb3V0ZXIgPSBleHByZXNzLlJvdXRlcigpOwoKLy8gTWlkZGxld2FyZSBmdW5jdGlvbiB0byBsb2cgcmVxdWVzdCBkZXRhaWxzCnJvdXRlci51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7CiAgY29uc29sZS5sb2coYCR7cmVxLm1ldGhvZH0gJHtyZXEudXJsfWApOwogIG5leHQoKTsKfSk7Cgpyb3V0ZXIuZ2V0KCcvJywgKHJlcSwgcmVzKSA9PiB7CiAgcmVzLnNlbmQoJ0hlbGxvIGZyb20gdGhlIHJvdXRlciEnKTsKfSk7CgphcHAudXNlKCcvcm91dGVyJywgcm91dGVyKTsKCmFwcC5saXN0ZW4oMzAwMCwgKCkgPT4gewogIGNvbnNvbGUubG9nKCdTZXJ2ZXIgaXMgcnVubmluZyBvbiBwb3J0IDMwMDAnKTsKfSk7"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const express = require('express');
const app = express();
const router = express.Router();

// Middleware function to log request details
router.use((req, res, next) =&gt; {
  console.log(`${req.method} ${req.url}`);
  next();
});

router.get('/', (req, res) =&gt; {
  res.send('Hello from the router!');
});

app.use('/router', router);

app.listen(3000, () =&gt; {
  console.log('Server is running on port 3000');
});</pre></div><div class='content'><p><strong>Explanation</strong>:</p>
<ul>
<li>The middleware function is applied to the router instance.</li>
<li>The router is mounted on the <code>/router</code> path.</li>
</ul>
</div><h2><p>Example 3: Error-Handling Middleware</p>
</h2>
<div class='content'><p>Error-handling middleware functions are defined with four arguments: <code>(err, req, res, next)</code>.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTsKY29uc3QgYXBwID0gZXhwcmVzcygpOwoKLy8gTWlkZGxld2FyZSBmdW5jdGlvbiB0byBzaW11bGF0ZSBhbiBlcnJvcgphcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4gewogIGNvbnN0IGVyciA9IG5ldyBFcnJvcignU29tZXRoaW5nIHdlbnQgd3JvbmchJyk7CiAgbmV4dChlcnIpOyAvLyBQYXNzIHRoZSBlcnJvciB0byB0aGUgZXJyb3ItaGFuZGxpbmcgbWlkZGxld2FyZQp9KTsKCi8vIEVycm9yLWhhbmRsaW5nIG1pZGRsZXdhcmUKYXBwLnVzZSgoZXJyLCByZXEsIHJlcywgbmV4dCkgPT4gewogIGNvbnNvbGUuZXJyb3IoZXJyLnN0YWNrKTsKICByZXMuc3RhdHVzKDUwMCkuc2VuZCgnSW50ZXJuYWwgU2VydmVyIEVycm9yJyk7Cn0pOwoKYXBwLmxpc3RlbigzMDAwLCAoKSA9PiB7CiAgY29uc29sZS5sb2coJ1NlcnZlciBpcyBydW5uaW5nIG9uIHBvcnQgMzAwMCcpOwp9KTs="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const express = require('express');
const app = express();

// Middleware function to simulate an error
app.use((req, res, next) =&gt; {
  const err = new Error('Something went wrong!');
  next(err); // Pass the error to the error-handling middleware
});

// Error-handling middleware
app.use((err, req, res, next) =&gt; {
  console.error(err.stack);
  res.status(500).send('Internal Server Error');
});

app.listen(3000, () =&gt; {
  console.log('Server is running on port 3000');
});</pre></div><div class='content'><p><strong>Explanation</strong>:</p>
<ul>
<li>The first middleware function simulates an error by creating an <code>Error</code> object and passing it to <code>next()</code>.</li>
<li>The error-handling middleware logs the error stack and sends a 500 status code with a message.</li>
</ul>
</div><h1><p>Practical Exercises</p>
</h1>
<div class='content'></div><h2><p>Exercise 1: Logging Middleware</p>
</h2>
<div class='content'><p><strong>Task</strong>: Create a middleware function that logs the request method, URL, and timestamp for each request.</p>
<p><strong>Solution</strong>:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTsKY29uc3QgYXBwID0gZXhwcmVzcygpOwoKLy8gTG9nZ2luZyBtaWRkbGV3YXJlCmFwcC51c2UoKHJlcSwgcmVzLCBuZXh0KSA9PiB7CiAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpOwogIGNvbnNvbGUubG9nKGBbJHt0aW1lc3RhbXB9XSAke3JlcS5tZXRob2R9ICR7cmVxLnVybH1gKTsKICBuZXh0KCk7Cn0pOwoKYXBwLmdldCgnLycsIChyZXEsIHJlcykgPT4gewogIHJlcy5zZW5kKCdIZWxsbywgV29ybGQhJyk7Cn0pOwoKYXBwLmxpc3RlbigzMDAwLCAoKSA9PiB7CiAgY29uc29sZS5sb2coJ1NlcnZlciBpcyBydW5uaW5nIG9uIHBvcnQgMzAwMCcpOwp9KTs="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const express = require('express');
const app = express();

// Logging middleware
app.use((req, res, next) =&gt; {
  const timestamp = new Date().toISOString();
  console.log(`[${timestamp}] ${req.method} ${req.url}`);
  next();
});

app.get('/', (req, res) =&gt; {
  res.send('Hello, World!');
});

app.listen(3000, () =&gt; {
  console.log('Server is running on port 3000');
});</pre></div><div class='content'></div><h2><p>Exercise 2: Authentication Middleware</p>
</h2>
<div class='content'><p><strong>Task</strong>: Create a middleware function that checks if a request has a valid API key in the query parameters. If the key is missing or invalid, respond with a 401 status code.</p>
<p><strong>Solution</strong>:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Y29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTsKY29uc3QgYXBwID0gZXhwcmVzcygpOwoKLy8gQXV0aGVudGljYXRpb24gbWlkZGxld2FyZQphcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4gewogIGNvbnN0IGFwaUtleSA9IHJlcS5xdWVyeS5hcGlLZXk7CiAgaWYgKGFwaUtleSA9PT0gJzEyMzQ1JykgewogICAgbmV4dCgpOyAvLyBWYWxpZCBBUEkga2V5LCBwcm9jZWVkIHRvIHRoZSBuZXh0IG1pZGRsZXdhcmUKICB9IGVsc2UgewogICAgcmVzLnN0YXR1cyg0MDEpLnNlbmQoJ1VuYXV0aG9yaXplZCcpOwogIH0KfSk7CgphcHAuZ2V0KCcvJywgKHJlcSwgcmVzKSA9PiB7CiAgcmVzLnNlbmQoJ0hlbGxvLCBhdXRoZW50aWNhdGVkIHVzZXIhJyk7Cn0pOwoKYXBwLmxpc3RlbigzMDAwLCAoKSA9PiB7CiAgY29uc29sZS5sb2coJ1NlcnZlciBpcyBydW5uaW5nIG9uIHBvcnQgMzAwMCcpOwp9KTs="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>const express = require('express');
const app = express();

// Authentication middleware
app.use((req, res, next) =&gt; {
  const apiKey = req.query.apiKey;
  if (apiKey === '12345') {
    next(); // Valid API key, proceed to the next middleware
  } else {
    res.status(401).send('Unauthorized');
  }
});

app.get('/', (req, res) =&gt; {
  res.send('Hello, authenticated user!');
});

app.listen(3000, () =&gt; {
  console.log('Server is running on port 3000');
});</pre></div><div class='content'></div><h1><p>Common Mistakes and Tips</p>
</h1>
<div class='content'><ul>
<li><strong>Forgetting to call <code>next()</code></strong>: If you forget to call <code>next()</code>, the request will hang and the response will never be sent.</li>
<li><strong>Order of middleware</strong>: The order in which middleware functions are defined matters. Ensure that middleware is defined before the routes that depend on it.</li>
<li><strong>Error-handling middleware</strong>: Always define error-handling middleware at the end of the middleware stack.</li>
</ul>
</div><h1><p>Conclusion</p>
</h1>
<div class='content'><p>Middleware functions are a powerful feature of Express.js that allow you to modularize and organize your code effectively. By understanding and utilizing different types of middleware, you can handle various aspects of request processing, such as logging, authentication, and error handling, in a clean and maintainable way. In the next topic, we will delve into routing in Express.js, which will build upon the concepts learned here.</p>
</div><div class='row navigation'>
	<div class='col-1 col-md-2'>
					<a href='06-02-setting-up-express' title="Setting Up an Express Application">
				<span class="d-none d-md-inline">&#x25C4; Previous</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-left-square-fill"></i></span>
			</a>
			</div>
	<div class='col-10 col-md-8 text-center'>
			</div>
	<div class='col-1 col-md-2 text-end'>
					<a href='06-04-routing-express' title="Routing in Express">
				<span class="d-none d-md-inline">Next &#x25BA;</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-right-square-fill"></i></span>
			</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Advertising</h1>
			<p>This space is reserved for advertising.</p>
			<p>If you want to be a sponsor, contact us to include links in this area: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>Thank you for collaborating!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. All rights reserved</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	We use cookies to improve your user experience and offer content tailored to your interests.
    <a href="#" id="btn_accept_cookies" class="button">Accept</a>
    <a href="/cookies">More Information</a>
</div>	

	</div>    
</body>
</html>
