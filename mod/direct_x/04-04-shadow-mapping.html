<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shadow Mapping</title>

    <link rel="alternate" href="https://campusempresa.com/mod/direct_x/04-04-shadow-mapping" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/direct_x/04-04-shadow-mapping" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/direct_x/04-04-shadow-mapping" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="/js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body >
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-8 p-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo-header_enterprise.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-4 px-0 py-2 py-md-0 text-end">
			<h2 id="main_title"><cite>Building today's and tomorrow's society</cite></h2>
			<h3 id="main_subtitle"></h3>
		</div>
	</div>
</div>
<div class="container-xxl" style="margin-top: -1em;">
	<div class="row">
		<div class="col-12 px-0 py-2 py-md-0 m-0 text-end">
													<b id="lit_lang_es" class="px-2">EN</b>
				|
				<a href="https://campusempresa.com/mod/direct_x/04-04-shadow-mapping" class="px-2">ES</a></b>
				|
				<a href="https://campusempresa.cat/mod/direct_x/04-04-shadow-mapping" class="px-2">CA</a>
					</div>
	</div>
</div>
   <div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				<a href="/objective">The Project</a>
				<a href="/about">About Us</a>
				<a href="/contribute">Contribute</a>
				<a href="/donate">Donations</a>
				<a href="/licence">License</a>
			</div>
		</div>
	</div>
   </div>

<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content">
								<div class='row navigation'>
	<div class='col-2'>
					<a href='04-03-advanced-lighting-techniques' title="Advanced Lighting Techniques">&#x25C4;Previous</a>
			</div>
	<div class='col-8 text-center'>
					<a href="./"><h2 style="text-decoration:underline">Shadow Mapping</h2></a>
			</div>
	<div class='col-2 text-end'>
					<a href='05-01-loading-3d-models' title="Loading 3D Models">Next &#x25BA;</a>
			</div>
</div>
<div class='content'><p>Shadow mapping is a technique used in 3D computer graphics to add shadows to a scene. It involves rendering the scene from the perspective of the light source to create a depth map, which is then used to determine which areas of the scene are in shadow when rendering from the camera's perspective.</p>
</div><h1>Key Concepts</h1>
<div class='content'><ol>
<li><strong>Depth Map</strong>: A texture that stores the depth information from the light's perspective.</li>
<li><strong>Light Space Transformation</strong>: Transforming world coordinates to the light's view space.</li>
<li><strong>Shadow Map Sampling</strong>: Comparing the depth of a fragment to the depth stored in the shadow map to determine if it is in shadow.</li>
</ol>
</div><h1>Steps to Implement Shadow Mapping</h1>
<div class='content'></div><h2>1. Render the Scene from the Light's Perspective</h2>
<div class='content'><p>First, you need to render the scene from the light's point of view to create the depth map.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gU2V0IHVwIHRoZSBsaWdodCdzIHZpZXcgYW5kIHByb2plY3Rpb24gbWF0cmljZXMKWE1NQVRSSVggbGlnaHRWaWV3TWF0cml4ID0gWE1NYXRyaXhMb29rQXRMSChsaWdodFBvc2l0aW9uLCBsaWdodFRhcmdldCwgdXBWZWN0b3IpOwpYTU1BVFJJWCBsaWdodFByb2plY3Rpb25NYXRyaXggPSBYTU1hdHJpeE9ydGhvZ3JhcGhpY0xIKGxpZ2h0V2lkdGgsIGxpZ2h0SGVpZ2h0LCBuZWFyUGxhbmUsIGZhclBsYW5lKTsKCi8vIFJlbmRlciB0aGUgc2NlbmUgdG8gdGhlIGRlcHRoIHRleHR1cmUKUmVuZGVyU2NlbmVUb0RlcHRoVGV4dHVyZShsaWdodFZpZXdNYXRyaXgsIGxpZ2h0UHJvamVjdGlvbk1hdHJpeCk7"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Set up the light's view and projection matrices
XMMATRIX lightViewMatrix = XMMatrixLookAtLH(lightPosition, lightTarget, upVector);
XMMATRIX lightProjectionMatrix = XMMatrixOrthographicLH(lightWidth, lightHeight, nearPlane, farPlane);

// Render the scene to the depth texture
RenderSceneToDepthTexture(lightViewMatrix, lightProjectionMatrix);</pre></div><div class='content'></div><h2>2. Create and Bind the Depth Texture</h2>
<div class='content'><p>Create a texture to store the depth information and bind it as the render target.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gQ3JlYXRlIHRoZSBkZXB0aCB0ZXh0dXJlCkQzRDExX1RFWFRVUkUyRF9ERVNDIGRlcHRoVGV4dHVyZURlc2MgPSB7fTsKZGVwdGhUZXh0dXJlRGVzYy5XaWR0aCA9IHRleHR1cmVXaWR0aDsKZGVwdGhUZXh0dXJlRGVzYy5IZWlnaHQgPSB0ZXh0dXJlSGVpZ2h0OwpkZXB0aFRleHR1cmVEZXNjLk1pcExldmVscyA9IDE7CmRlcHRoVGV4dHVyZURlc2MuQXJyYXlTaXplID0gMTsKZGVwdGhUZXh0dXJlRGVzYy5Gb3JtYXQgPSBEWEdJX0ZPUk1BVF9SMzJfVFlQRUxFU1M7CmRlcHRoVGV4dHVyZURlc2MuU2FtcGxlRGVzYy5Db3VudCA9IDE7CmRlcHRoVGV4dHVyZURlc2MuVXNhZ2UgPSBEM0QxMV9VU0FHRV9ERUZBVUxUOwpkZXB0aFRleHR1cmVEZXNjLkJpbmRGbGFncyA9IEQzRDExX0JJTkRfREVQVEhfU1RFTkNJTCB8IEQzRDExX0JJTkRfU0hBREVSX1JFU09VUkNFOwoKSUQzRDExVGV4dHVyZTJEKiBkZXB0aFRleHR1cmU7CmRldmljZS0+Q3JlYXRlVGV4dHVyZTJEKCZkZXB0aFRleHR1cmVEZXNjLCBudWxscHRyLCAmZGVwdGhUZXh0dXJlKTsKCi8vIENyZWF0ZSB0aGUgZGVwdGggc3RlbmNpbCB2aWV3CkQzRDExX0RFUFRIX1NURU5DSUxfVklFV19ERVNDIGRzdkRlc2MgPSB7fTsKZHN2RGVzYy5Gb3JtYXQgPSBEWEdJX0ZPUk1BVF9EMzJfRkxPQVQ7CmRzdkRlc2MuVmlld0RpbWVuc2lvbiA9IEQzRDExX0RTVl9ESU1FTlNJT05fVEVYVFVSRTJEOwpkc3ZEZXNjLlRleHR1cmUyRC5NaXBTbGljZSA9IDA7CgpJRDNEMTFEZXB0aFN0ZW5jaWxWaWV3KiBkZXB0aFN0ZW5jaWxWaWV3OwpkZXZpY2UtPkNyZWF0ZURlcHRoU3RlbmNpbFZpZXcoZGVwdGhUZXh0dXJlLCAmZHN2RGVzYywgJmRlcHRoU3RlbmNpbFZpZXcpOwoKLy8gQmluZCB0aGUgZGVwdGggc3RlbmNpbCB2aWV3CmNvbnRleHQtPk9NU2V0UmVuZGVyVGFyZ2V0cygwLCBudWxscHRyLCBkZXB0aFN0ZW5jaWxWaWV3KTs="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Create the depth texture
D3D11_TEXTURE2D_DESC depthTextureDesc = {};
depthTextureDesc.Width = textureWidth;
depthTextureDesc.Height = textureHeight;
depthTextureDesc.MipLevels = 1;
depthTextureDesc.ArraySize = 1;
depthTextureDesc.Format = DXGI_FORMAT_R32_TYPELESS;
depthTextureDesc.SampleDesc.Count = 1;
depthTextureDesc.Usage = D3D11_USAGE_DEFAULT;
depthTextureDesc.BindFlags = D3D11_BIND_DEPTH_STENCIL | D3D11_BIND_SHADER_RESOURCE;

ID3D11Texture2D* depthTexture;
device-&gt;CreateTexture2D(&amp;depthTextureDesc, nullptr, &amp;depthTexture);

// Create the depth stencil view
D3D11_DEPTH_STENCIL_VIEW_DESC dsvDesc = {};
dsvDesc.Format = DXGI_FORMAT_D32_FLOAT;
dsvDesc.ViewDimension = D3D11_DSV_DIMENSION_TEXTURE2D;
dsvDesc.Texture2D.MipSlice = 0;

ID3D11DepthStencilView* depthStencilView;
device-&gt;CreateDepthStencilView(depthTexture, &amp;dsvDesc, &amp;depthStencilView);

// Bind the depth stencil view
context-&gt;OMSetRenderTargets(0, nullptr, depthStencilView);</pre></div><div class='content'></div><h2>3. Render the Scene from the Camera's Perspective</h2>
<div class='content'><p>Render the scene from the camera's perspective, using the depth map to determine shadows.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("Ly8gU2V0IHVwIHRoZSBjYW1lcmEncyB2aWV3IGFuZCBwcm9qZWN0aW9uIG1hdHJpY2VzClhNTUFUUklYIGNhbWVyYVZpZXdNYXRyaXggPSBYTU1hdHJpeExvb2tBdExIKGNhbWVyYVBvc2l0aW9uLCBjYW1lcmFUYXJnZXQsIHVwVmVjdG9yKTsKWE1NQVRSSVggY2FtZXJhUHJvamVjdGlvbk1hdHJpeCA9IFhNTWF0cml4UGVyc3BlY3RpdmVGb3ZMSChmb3YsIGFzcGVjdFJhdGlvLCBuZWFyUGxhbmUsIGZhclBsYW5lKTsKCi8vIFJlbmRlciB0aGUgc2NlbmUgd2l0aCBzaGFkb3cgbWFwcGluZwpSZW5kZXJTY2VuZVdpdGhTaGFkb3dzKGNhbWVyYVZpZXdNYXRyaXgsIGNhbWVyYVByb2plY3Rpb25NYXRyaXgsIGxpZ2h0Vmlld01hdHJpeCwgbGlnaHRQcm9qZWN0aW9uTWF0cml4LCBkZXB0aFRleHR1cmUpOw=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>// Set up the camera's view and projection matrices
XMMATRIX cameraViewMatrix = XMMatrixLookAtLH(cameraPosition, cameraTarget, upVector);
XMMATRIX cameraProjectionMatrix = XMMatrixPerspectiveFovLH(fov, aspectRatio, nearPlane, farPlane);

// Render the scene with shadow mapping
RenderSceneWithShadows(cameraViewMatrix, cameraProjectionMatrix, lightViewMatrix, lightProjectionMatrix, depthTexture);</pre></div><div class='content'></div><h2>4. Sample the Shadow Map in the Shader</h2>
<div class='content'><p>In the pixel shader, sample the shadow map to determine if a fragment is in shadow.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("VGV4dHVyZTJEPGZsb2F0PiBzaGFkb3dNYXAgOiByZWdpc3Rlcih0MCk7ClNhbXBsZXJTdGF0ZSBzaGFkb3dTYW1wbGVyIDogcmVnaXN0ZXIoczApOwoKZmxvYXQ0IG1haW5QUyhWZXJ0ZXhPdXQgaW5wdXQpIDogU1ZfVGFyZ2V0IHsKICAgIC8vIFRyYW5zZm9ybSB0aGUgZnJhZ21lbnQgcG9zaXRpb24gdG8gbGlnaHQgc3BhY2UKICAgIGZsb2F0NCBsaWdodFNwYWNlUG9zID0gbXVsKGlucHV0LndvcmxkUG9zLCBsaWdodFZpZXdQcm9qZWN0aW9uTWF0cml4KTsKICAgIGxpZ2h0U3BhY2VQb3MgLz0gbGlnaHRTcGFjZVBvcy53OwoKICAgIC8vIFNhbXBsZSB0aGUgc2hhZG93IG1hcAogICAgZmxvYXQgc2hhZG93RGVwdGggPSBzaGFkb3dNYXAuU2FtcGxlKHNoYWRvd1NhbXBsZXIsIGxpZ2h0U3BhY2VQb3MueHkpLnI7CgogICAgLy8gQ29tcGFyZSB0aGUgZnJhZ21lbnQgZGVwdGggd2l0aCB0aGUgc2hhZG93IG1hcCBkZXB0aAogICAgZmxvYXQgc2hhZG93RmFjdG9yID0gKGxpZ2h0U3BhY2VQb3MueiA+IHNoYWRvd0RlcHRoICsgc2hhZG93QmlhcykgPyAwLjBmIDogMS4wZjsKCiAgICAvLyBDYWxjdWxhdGUgdGhlIGZpbmFsIGNvbG9yCiAgICBmbG9hdDQgY29sb3IgPSBpbnB1dC5jb2xvciAqIHNoYWRvd0ZhY3RvcjsKICAgIHJldHVybiBjb2xvcjsKfQ=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>Texture2D&lt;float&gt; shadowMap : register(t0);
SamplerState shadowSampler : register(s0);

float4 mainPS(VertexOut input) : SV_Target {
    // Transform the fragment position to light space
    float4 lightSpacePos = mul(input.worldPos, lightViewProjectionMatrix);
    lightSpacePos /= lightSpacePos.w;

    // Sample the shadow map
    float shadowDepth = shadowMap.Sample(shadowSampler, lightSpacePos.xy).r;

    // Compare the fragment depth with the shadow map depth
    float shadowFactor = (lightSpacePos.z &gt; shadowDepth + shadowBias) ? 0.0f : 1.0f;

    // Calculate the final color
    float4 color = input.color * shadowFactor;
    return color;
}</pre></div><div class='content'></div><h1>Practical Exercise</h1>
<div class='content'></div><h2>Exercise: Implement Basic Shadow Mapping</h2>
<div class='content'><ol>
<li><strong>Setup</strong>: Create a DirectX project and set up the necessary shaders and resources.</li>
<li><strong>Depth Map Creation</strong>: Implement the code to render the scene from the light's perspective and create a depth map.</li>
<li><strong>Shadow Map Sampling</strong>: Modify the pixel shader to sample the shadow map and apply shadows to the scene.</li>
</ol>
</div><h2>Solution</h2>
<div class='content'><ol>
<li><strong>Setup</strong>: Follow the steps outlined in the &quot;Setting Up the Development Environment&quot; section of Module 1.</li>
<li><strong>Depth Map Creation</strong>: Use the provided code snippets to create and bind the depth texture, and render the scene from the light's perspective.</li>
<li><strong>Shadow Map Sampling</strong>: Implement the provided HLSL code in your pixel shader to sample the shadow map and apply shadows.</li>
</ol>
</div><h1>Common Mistakes and Tips</h1>
<div class='content'><ul>
<li><strong>Depth Precision</strong>: Ensure that the depth texture format and depth comparison in the shader are precise enough to avoid shadow artifacts.</li>
<li><strong>Shadow Acne</strong>: Use a small bias when comparing depths to prevent shadow acne, where surfaces incorrectly self-shadow.</li>
<li><strong>Performance</strong>: Optimize the shadow map resolution and sampling to balance quality and performance.</li>
</ul>
</div><h1>Conclusion</h1>
<div class='content'><p>Shadow mapping is a powerful technique for adding realistic shadows to a 3D scene. By understanding and implementing the steps to create and use a depth map, you can enhance the visual quality of your DirectX applications. In the next module, we will explore more advanced rendering techniques to further improve your graphics programming skills.</p>
</div><div class='row navigation'>
	<div class='col-2'>
					<a href='04-03-advanced-lighting-techniques' title="Advanced Lighting Techniques">&#x25C4;Previous</a>
			</div>
	<div class='col-8 text-center'>
			</div>
	<div class='col-2 text-end'>
					<a href='05-01-loading-3d-models' title="Loading 3D Models">Next &#x25BA;</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Advertising</h1>
			<p>This space is reserved for advertising.</p>
			<p>If you want to be a sponsor, contact us to include links in this area: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>Thank you for collaborating!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. All rights reserved</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	Fem servir galetes per millorar la teva experiència d'ús i oferir continguts adaptats als teus interessos
    <a href="#" id="btn_accept_cookies" class="button">Accept</a>
    <a href="/cookies">More Information</a>
</div>	

	</div>    
</body>
</html>
