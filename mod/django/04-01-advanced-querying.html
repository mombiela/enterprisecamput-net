<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Querying with Django ORM</title>

    <link rel="alternate" href="https://campusempresa.com/mod/django/04-01-advanced-querying" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/django/04-01-advanced-querying" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/django/04-01-advanced-querying" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css?v=2" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="/js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
	<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0611338592562725" crossorigin="anonymous"></script>  	
	</head>

<body >
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-6 p-2 p-md-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo-header_enterprise.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-6 p-2 p-md-0 text-end">
				<b id="lit_lang_es" class="px-2">EN</b>
	|
	<a href="https://campusempresa.com/mod/django/04-01-advanced-querying" class="px-2">ES</a></b>
	|
	<a href="https://campusempresa.cat/mod/django/04-01-advanced-querying" class="px-2">CA</a>
<br>
			<cite>Building today's and tomorrow's society</cite>
		</div>
	</div>
</div>
<div id="subheader" class="container-xxl">
	<div class="row">
		<div class="col-12 p-2 p-md-0 m-0 text-end">
			<a href="/objective">The Project</a> | 
<a href="/about">About Us</a> | 
<a href="/contribute">Contribute</a> | 
<a href="/donate">Donations</a> | 
<a href="/licence">License</a>
		</div>
	</div>
</div>

<div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				 					<a href="/categ/languages">Programming Languages</a>
				 					<a href="/categ/frameworks">Frameworks and Libraries</a>
				 					<a href="/categ/tech-tools">Technical Tools</a>
				 					<a href="/categ/foundations">Theoretical Foundations</a>
				 					<a href="/categ/soft-skills">Social Skills</a>
							</div>
		</div>
	</div>
</div>
		
<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content">
				<div class='row navigation'>
	<div class='col-1 col-md-2'>
					<a href='03-05-file-uploads' title="File Uploads">
				<span class="d-none d-md-inline">&#x25C4; Previous</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-left-square-fill"></i></span>
			</a>
			</div>
	<div class='col-10 col-md-8 text-center'>
					<a href="./"><h2 style="text-decoration:underline">Advanced Querying with Django ORM</h2></a>
			</div>
	<div class='col-1 col-md-2 text-end'>
					<a href='04-02-custom-user-models' title="Custom User Models">
				<span class="d-none d-md-inline">Next &#x25BA;</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-right-square-fill"></i></span>
			</a>
			</div>
</div>
<div class='content'><p>In this section, we will delve into advanced querying techniques using Django's Object-Relational Mapping (ORM). This will help you perform complex database operations efficiently and effectively.</p>
</div><h1><p>Key Concepts</p>
</h1>
<div class='content'><ol>
<li><strong>QuerySet Methods</strong>: Learn about advanced QuerySet methods for filtering, annotating, and aggregating data.</li>
<li><strong>Complex Lookups</strong>: Understand how to use Q objects for complex queries.</li>
<li><strong>Database Functions</strong>: Utilize database functions for more advanced operations.</li>
<li><strong>Subqueries</strong>: Implement subqueries to perform nested queries.</li>
<li><strong>Raw SQL</strong>: When and how to use raw SQL queries in Django.</li>
</ol>
</div><h1><p>QuerySet Methods</p>
</h1>
<div class='content'></div><h2><p>Filtering and Excluding Data</p>
</h2>
<div class='content'><p>Django provides powerful methods to filter and exclude data from your QuerySets.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBteWFwcC5tb2RlbHMgaW1wb3J0IFByb2R1Y3QKCiMgRmlsdGVyaW5nIHByb2R1Y3RzIHdpdGggcHJpY2UgZ3JlYXRlciB0aGFuIDEwMApleHBlbnNpdmVfcHJvZHVjdHMgPSBQcm9kdWN0Lm9iamVjdHMuZmlsdGVyKHByaWNlX19ndD0xMDApCgojIEV4Y2x1ZGluZyBwcm9kdWN0cyB0aGF0IGFyZSBvdXQgb2Ygc3RvY2sKYXZhaWxhYmxlX3Byb2R1Y3RzID0gUHJvZHVjdC5vYmplY3RzLmV4Y2x1ZGUoc3RvY2s9MCk="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from myapp.models import Product

# Filtering products with price greater than 100
expensive_products = Product.objects.filter(price__gt=100)

# Excluding products that are out of stock
available_products = Product.objects.exclude(stock=0)</pre></div><div class='content'></div><h2><p>Annotating and Aggregating Data</p>
</h2>
<div class='content'><p>Annotations and aggregations allow you to perform calculations on your data.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBkamFuZ28uZGIubW9kZWxzIGltcG9ydCBDb3VudCwgQXZnCgojIEFubm90YXRpbmcgdGhlIG51bWJlciBvZiBvcmRlcnMgZm9yIGVhY2ggcHJvZHVjdApwcm9kdWN0c193aXRoX29yZGVyX2NvdW50ID0gUHJvZHVjdC5vYmplY3RzLmFubm90YXRlKG9yZGVyX2NvdW50PUNvdW50KCdvcmRlcicpKQoKIyBBZ2dyZWdhdGluZyB0aGUgYXZlcmFnZSBwcmljZSBvZiBhbGwgcHJvZHVjdHMKYXZlcmFnZV9wcmljZSA9IFByb2R1Y3Qub2JqZWN0cy5hZ2dyZWdhdGUoQXZnKCdwcmljZScpKQ=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from django.db.models import Count, Avg

# Annotating the number of orders for each product
products_with_order_count = Product.objects.annotate(order_count=Count('order'))

# Aggregating the average price of all products
average_price = Product.objects.aggregate(Avg('price'))</pre></div><div class='content'></div><h1><p>Complex Lookups with Q Objects</p>
</h1>
<div class='content'><p>Q objects allow you to perform complex queries involving OR, AND, and NOT operations.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBkamFuZ28uZGIubW9kZWxzIGltcG9ydCBRCgojIFByb2R1Y3RzIHRoYXQgYXJlIGVpdGhlciBvdXQgb2Ygc3RvY2sgb3IgaGF2ZSBhIHByaWNlIGdyZWF0ZXIgdGhhbiAxMDAKY29tcGxleF9xdWVyeSA9IFByb2R1Y3Qub2JqZWN0cy5maWx0ZXIoUShzdG9jaz0wKSB8IFEocHJpY2VfX2d0PTEwMCkp"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from django.db.models import Q

# Products that are either out of stock or have a price greater than 100
complex_query = Product.objects.filter(Q(stock=0) | Q(price__gt=100))</pre></div><div class='content'></div><h1><p>Database Functions</p>
</h1>
<div class='content'><p>Django provides various database functions for more advanced operations.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBkamFuZ28uZGIubW9kZWxzIGltcG9ydCBGLCBGdW5jCgojIFVzaW5nIEYgZXhwcmVzc2lvbnMgdG8gcGVyZm9ybSBhcml0aG1ldGljIG9wZXJhdGlvbnMKZGlzY291bnRlZF9wcm9kdWN0cyA9IFByb2R1Y3Qub2JqZWN0cy5maWx0ZXIocHJpY2VfX2x0PUYoJ29yaWdpbmFsX3ByaWNlJykgKiAwLjgpCgojIFVzaW5nIEZ1bmMgdG8gcGVyZm9ybSBjdXN0b20gZGF0YWJhc2UgZnVuY3Rpb25zCmZyb20gZGphbmdvLmRiLm1vZGVscy5mdW5jdGlvbnMgaW1wb3J0IExlbmd0aApwcm9kdWN0c193aXRoX2xvbmdfbmFtZXMgPSBQcm9kdWN0Lm9iamVjdHMuYW5ub3RhdGUobmFtZV9sZW5ndGg9TGVuZ3RoKCduYW1lJykpLmZpbHRlcihuYW1lX2xlbmd0aF9fZ3Q9MjAp"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from django.db.models import F, Func

# Using F expressions to perform arithmetic operations
discounted_products = Product.objects.filter(price__lt=F('original_price') * 0.8)

# Using Func to perform custom database functions
from django.db.models.functions import Length
products_with_long_names = Product.objects.annotate(name_length=Length('name')).filter(name_length__gt=20)</pre></div><div class='content'></div><h1><p>Subqueries</p>
</h1>
<div class='content'><p>Subqueries allow you to perform nested queries.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBkamFuZ28uZGIubW9kZWxzIGltcG9ydCBPdXRlclJlZiwgU3VicXVlcnkKCiMgU3VicXVlcnkgdG8gZ2V0IHRoZSBsYXRlc3Qgb3JkZXIgZGF0ZSBmb3IgZWFjaCBwcm9kdWN0CmxhdGVzdF9vcmRlcl9kYXRlID0gT3JkZXIub2JqZWN0cy5maWx0ZXIocHJvZHVjdD1PdXRlclJlZigncGsnKSkub3JkZXJfYnkoJy1kYXRlJykudmFsdWVzKCdkYXRlJylbOjFdCnByb2R1Y3RzX3dpdGhfbGF0ZXN0X29yZGVyX2RhdGUgPSBQcm9kdWN0Lm9iamVjdHMuYW5ub3RhdGUobGF0ZXN0X29yZGVyX2RhdGU9U3VicXVlcnkobGF0ZXN0X29yZGVyX2RhdGUpKQ=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from django.db.models import OuterRef, Subquery

# Subquery to get the latest order date for each product
latest_order_date = Order.objects.filter(product=OuterRef('pk')).order_by('-date').values('date')[:1]
products_with_latest_order_date = Product.objects.annotate(latest_order_date=Subquery(latest_order_date))</pre></div><div class='content'></div><h1><p>Raw SQL</p>
</h1>
<div class='content'><p>While Django ORM is powerful, sometimes you may need to execute raw SQL queries.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBkamFuZ28uZGIgaW1wb3J0IGNvbm5lY3Rpb24KCmRlZiBnZXRfY3VzdG9tZXJzX3dpdGhfaGlnaF9zcGVuZGluZygpOgogICAgd2l0aCBjb25uZWN0aW9uLmN1cnNvcigpIGFzIGN1cnNvcjoKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgU0VMRUNUIGN1c3RvbWVyX2lkLCBTVU0odG90YWxfYW1vdW50KSBhcyB0b3RhbF9zcGVudAogICAgICAgICAgICBGUk9NIG9yZGVycwogICAgICAgICAgICBHUk9VUCBCWSBjdXN0b21lcl9pZAogICAgICAgICAgICBIQVZJTkcgdG90YWxfc3BlbnQgPiAxMDAwCiAgICAgICAgIiIiKQogICAgICAgIHJvd3MgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgcmV0dXJuIHJvd3M="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from django.db import connection

def get_customers_with_high_spending():
    with connection.cursor() as cursor:
        cursor.execute(&quot;&quot;&quot;
            SELECT customer_id, SUM(total_amount) as total_spent
            FROM orders
            GROUP BY customer_id
            HAVING total_spent &gt; 1000
        &quot;&quot;&quot;)
        rows = cursor.fetchall()
    return rows</pre></div><div class='content'></div><h1><p>Practical Exercises</p>
</h1>
<div class='content'></div><h2><p>Exercise 1: Filtering and Annotating</p>
</h2>
<div class='content'><p><strong>Task</strong>: Retrieve all products that have been ordered more than 10 times and calculate the average price of these products.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBteWFwcC5tb2RlbHMgaW1wb3J0IFByb2R1Y3QKZnJvbSBkamFuZ28uZGIubW9kZWxzIGltcG9ydCBDb3VudCwgQXZnCgojIFNvbHV0aW9uCnByb2R1Y3RzX3dpdGhfaGlnaF9vcmRlcnMgPSBQcm9kdWN0Lm9iamVjdHMuYW5ub3RhdGUob3JkZXJfY291bnQ9Q291bnQoJ29yZGVyJykpLmZpbHRlcihvcmRlcl9jb3VudF9fZ3Q9MTApCmF2ZXJhZ2VfcHJpY2UgPSBwcm9kdWN0c193aXRoX2hpZ2hfb3JkZXJzLmFnZ3JlZ2F0ZShBdmcoJ3ByaWNlJykpCnByaW50KGF2ZXJhZ2VfcHJpY2Up"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from myapp.models import Product
from django.db.models import Count, Avg

# Solution
products_with_high_orders = Product.objects.annotate(order_count=Count('order')).filter(order_count__gt=10)
average_price = products_with_high_orders.aggregate(Avg('price'))
print(average_price)</pre></div><div class='content'></div><h2><p>Exercise 2: Complex Lookups</p>
</h2>
<div class='content'><p><strong>Task</strong>: Retrieve all products that are either out of stock or have a price less than 50, but not both.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBteWFwcC5tb2RlbHMgaW1wb3J0IFByb2R1Y3QKZnJvbSBkamFuZ28uZGIubW9kZWxzIGltcG9ydCBRCgojIFNvbHV0aW9uCmNvbXBsZXhfcXVlcnkgPSBQcm9kdWN0Lm9iamVjdHMuZmlsdGVyKFEoc3RvY2s9MCkgfCBRKHByaWNlX19sdD01MCkpLmV4Y2x1ZGUoUShzdG9jaz0wKSAmIFEocHJpY2VfX2x0PTUwKSkKcHJpbnQoY29tcGxleF9xdWVyeSk="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from myapp.models import Product
from django.db.models import Q

# Solution
complex_query = Product.objects.filter(Q(stock=0) | Q(price__lt=50)).exclude(Q(stock=0) &amp; Q(price__lt=50))
print(complex_query)</pre></div><div class='content'></div><h2><p>Exercise 3: Subqueries</p>
</h2>
<div class='content'><p><strong>Task</strong>: Retrieve the latest order date for each product and display the product name along with this date.</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ZnJvbSBteWFwcC5tb2RlbHMgaW1wb3J0IFByb2R1Y3QsIE9yZGVyCmZyb20gZGphbmdvLmRiLm1vZGVscyBpbXBvcnQgT3V0ZXJSZWYsIFN1YnF1ZXJ5CgojIFNvbHV0aW9uCmxhdGVzdF9vcmRlcl9kYXRlID0gT3JkZXIub2JqZWN0cy5maWx0ZXIocHJvZHVjdD1PdXRlclJlZigncGsnKSkub3JkZXJfYnkoJy1kYXRlJykudmFsdWVzKCdkYXRlJylbOjFdCnByb2R1Y3RzX3dpdGhfbGF0ZXN0X29yZGVyX2RhdGUgPSBQcm9kdWN0Lm9iamVjdHMuYW5ub3RhdGUobGF0ZXN0X29yZGVyX2RhdGU9U3VicXVlcnkobGF0ZXN0X29yZGVyX2RhdGUpKQpmb3IgcHJvZHVjdCBpbiBwcm9kdWN0c193aXRoX2xhdGVzdF9vcmRlcl9kYXRlOgogICAgcHJpbnQocHJvZHVjdC5uYW1lLCBwcm9kdWN0LmxhdGVzdF9vcmRlcl9kYXRlKQ=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>from myapp.models import Product, Order
from django.db.models import OuterRef, Subquery

# Solution
latest_order_date = Order.objects.filter(product=OuterRef('pk')).order_by('-date').values('date')[:1]
products_with_latest_order_date = Product.objects.annotate(latest_order_date=Subquery(latest_order_date))
for product in products_with_latest_order_date:
    print(product.name, product.latest_order_date)</pre></div><div class='content'></div><h1><p>Common Mistakes and Tips</p>
</h1>
<div class='content'><ul>
<li><strong>Using <code>filter</code> vs <code>exclude</code></strong>: Ensure you understand the difference between filtering and excluding data.</li>
<li><strong>Efficient Queries</strong>: Use annotations and aggregations wisely to avoid performance issues.</li>
<li><strong>Q Objects</strong>: When using Q objects, remember to use parentheses to group conditions correctly.</li>
<li><strong>Subqueries</strong>: Be cautious with subqueries as they can impact performance if not used properly.</li>
<li><strong>Raw SQL</strong>: Use raw SQL sparingly and only when necessary, as it bypasses Django's ORM and can lead to SQL injection if not handled properly.</li>
</ul>
</div><h1><p>Conclusion</p>
</h1>
<div class='content'><p>In this section, we explored advanced querying techniques using Django ORM. You learned how to filter, annotate, and aggregate data, perform complex lookups with Q objects, use database functions, implement subqueries, and execute raw SQL queries. These skills will enable you to handle complex database operations efficiently in your Django applications.</p>
<p>Next, we will move on to <strong>Custom User Models</strong>, where you will learn how to create and manage custom user models in Django.</p>
</div><div class='row navigation'>
	<div class='col-1 col-md-2'>
					<a href='03-05-file-uploads' title="File Uploads">
				<span class="d-none d-md-inline">&#x25C4; Previous</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-left-square-fill"></i></span>
			</a>
			</div>
	<div class='col-10 col-md-8 text-center'>
			</div>
	<div class='col-1 col-md-2 text-end'>
					<a href='04-02-custom-user-models' title="Custom User Models">
				<span class="d-none d-md-inline">Next &#x25BA;</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-right-square-fill"></i></span>
			</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<!-- 
<h1>Advertising</h1>
<p>This space is reserved for advertising.</p>
<p>If you want to be a sponsor, contact us to include links in this area: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
<p>Thank you for collaborating!</p>
-->

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0611338592562725"
     crossorigin="anonymous"></script>
<!-- enterprise_campus -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-0611338592562725"
     data-ad-slot="6914733106"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. All rights reserved</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	We use cookies to improve your user experience and offer content tailored to your interests.
    <a href="#" id="btn_accept_cookies" class="button">Accept</a>
    <a href="/cookies">More Information</a>
</div>	

	</div>    
</body>
</html>
