<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripting</title>

    <link rel="alternate" href="https://campusempresa.com/mod/elasticsearch/03-04-scripting" hreflang="es" />
	<link rel="alternate" href="https://campusempresa.cat/mod/elasticsearch/03-04-scripting" hreflang="ca" />
	<link rel="alternate" href="https://enterprisecampus.net/mod/elasticsearch/03-04-scripting" hreflang="en" />
    
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
	<link href="/css/site.css" rel="stylesheet">
	
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  	<script type="text/javascript" src="/js/math_init.js"></script>
  	<script type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/startup.js"></script>
  	<script type="text/javascript" src="/js/cookie.js"></script>
  	<script type="text/javascript" src="/js/main.js"></script>
</head>

<body >
    <div id="content">
		<div id="header" class="container-xxl">
	<div class="row">
		<div class="col-12 col-md-6 p-2 p-md-0">
			<h1 class="m-0 p-0">
				<a href="/"><img src="/img/logo-header_enterprise.png"></a>
			</h1>
		</div>
		<div class="col-12 col-md-6 p-2 p-md-0 text-end">
				<b id="lit_lang_es" class="px-2">EN</b>
	|
	<a href="https://campusempresa.com/mod/elasticsearch/03-04-scripting" class="px-2">ES</a></b>
	|
	<a href="https://campusempresa.cat/mod/elasticsearch/03-04-scripting" class="px-2">CA</a>
<br>
			<cite>Building today's and tomorrow's society</cite>
		</div>
	</div>
</div>
<div id="subheader" class="container-xxl">
	<div class="row">
		<div class="col-12 p-2 p-md-0 m-0 text-end">
			<a href="/objective">The Project</a> | 
<a href="/about">About Us</a> | 
<a href="/contribute">Contribute</a> | 
<a href="/donate">Donations</a> | 
<a href="/licence">License</a>
		</div>
	</div>
</div>

<div class="top-bar container-fluid">
	<div class="container-xxl">
		<div class="row">
			<div class="col" id="left_menu">
				 					<a href="/categ/languages">Programming Languages</a>
				 					<a href="/categ/frameworks">Frameworks and Libraries</a>
				 					<a href="/categ/tech-tools">Technical Tools</a>
				 					<a href="/categ/foundations">Theoretical Foundations</a>
				 					<a href="/categ/soft-skills">Social Skills</a>
							</div>
		</div>
	</div>
</div>
		
<div class="container-xxl" id="main_content">
	<div class="row">
		<div class="col-12 col-lg-8">
			<div id="nav1" class="navigation"></div>
			<div id="inner_content">
				<div class='row navigation'>
	<div class='col-1 col-md-2'>
					<a href='03-03-aggregations' title="Aggregations">
				<span class="d-none d-md-inline">&#x25C4; Previous</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-left-square-fill"></i></span>
			</a>
			</div>
	<div class='col-10 col-md-8 text-center'>
					<a href="./"><h2 style="text-decoration:underline">Scripting</h2></a>
			</div>
	<div class='col-1 col-md-2 text-end'>
					<a href='04-01-mapping-analyzers' title="Mapping and Analyzers">
				<span class="d-none d-md-inline">Next &#x25BA;</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-right-square-fill"></i></span>
			</a>
			</div>
</div>
<div class='content'><p>In this section, we will explore how to use scripting in Elasticsearch to perform complex operations that are not possible with standard queries. Scripting can be used in various parts of Elasticsearch, such as during searches, updates, and aggregations. We will cover the following topics:</p>
<ol>
<li><strong>Introduction to Scripting in Elasticsearch</strong></li>
<li><strong>Supported Scripting Languages</strong></li>
<li><strong>Using Painless Scripting Language</strong></li>
<li><strong>Practical Examples of Scripting</strong></li>
<li><strong>Security Considerations</strong></li>
<li><strong>Exercises</strong></li>
</ol>
</div><h1><ol>
<li>Introduction to Scripting in Elasticsearch</li>
</ol>
</h1>
<div class='content'><p>Scripting in Elasticsearch allows you to perform custom operations on your data. Scripts can be used to:</p>
<ul>
<li>Calculate custom scores for documents.</li>
<li>Update documents with complex logic.</li>
<li>Perform custom aggregations.</li>
</ul>
</div><h1><ol start="2">
<li>Supported Scripting Languages</li>
</ol>
</h1>
<div class='content'><p>Elasticsearch supports several scripting languages, but the most commonly used and recommended one is <strong>Painless</strong>. Other supported languages include:</p>
<ul>
<li><strong>Expression</strong>: A simple, safe scripting language.</li>
<li><strong>Mustache</strong>: Used for templating.</li>
<li><strong>Groovy</strong>: Deprecated and not recommended for use.</li>
</ul>
</div><h1><ol start="3">
<li>Using Painless Scripting Language</li>
</ol>
</h1>
<div class='content'><p>Painless is a simple, secure, and performant scripting language designed specifically for Elasticsearch. It is the default and recommended scripting language.</p>
</div><h2><p>Basic Syntax</p>
</h2>
<div class='content'><p>Here is a simple example of a Painless script that adds two numbers:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("aW50IGEgPSA1OwppbnQgYiA9IDM7CnJldHVybiBhICsgYjs="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>int a = 5;
int b = 3;
return a + b;</pre></div><div class='content'></div><h2><p>Using Painless in Queries</p>
</h2>
<div class='content'><p>You can use Painless scripts in various parts of Elasticsearch queries. For example, to calculate a custom score for documents:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ewogICJxdWVyeSI6IHsKICAgICJmdW5jdGlvbl9zY29yZSI6IHsKICAgICAgInNjcmlwdF9zY29yZSI6IHsKICAgICAgICAic2NyaXB0IjogewogICAgICAgICAgInNvdXJjZSI6ICJkb2NbJ2ZpZWxkX25hbWUnXS52YWx1ZSAqIDIiCiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfQp9"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>{
  &quot;query&quot;: {
    &quot;function_score&quot;: {
      &quot;script_score&quot;: {
        &quot;script&quot;: {
          &quot;source&quot;: &quot;doc['field_name'].value * 2&quot;
        }
      }
    }
  }
}</pre></div><div class='content'></div><h2><p>Using Painless in Updates</p>
</h2>
<div class='content'><p>You can also use Painless scripts to update documents. For example, to increment a field value:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ewogICJzY3JpcHQiOiB7CiAgICAic291cmNlIjogImN0eC5fc291cmNlLmZpZWxkX25hbWUgKz0gcGFyYW1zLmluY3JlbWVudCIsCiAgICAicGFyYW1zIjogewogICAgICAiaW5jcmVtZW50IjogMQogICAgfQogIH0KfQ=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>{
  &quot;script&quot;: {
    &quot;source&quot;: &quot;ctx._source.field_name += params.increment&quot;,
    &quot;params&quot;: {
      &quot;increment&quot;: 1
    }
  }
}</pre></div><div class='content'></div><h1><ol start="4">
<li>Practical Examples of Scripting</li>
</ol>
</h1>
<div class='content'></div><h2><p>Example 1: Custom Scoring</p>
</h2>
<div class='content'><p>Let's say you want to boost the score of documents based on a custom formula:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ewogICJxdWVyeSI6IHsKICAgICJmdW5jdGlvbl9zY29yZSI6IHsKICAgICAgInF1ZXJ5IjogewogICAgICAgICJtYXRjaF9hbGwiOiB7fQogICAgICB9LAogICAgICAic2NyaXB0X3Njb3JlIjogewogICAgICAgICJzY3JpcHQiOiB7CiAgICAgICAgICAic291cmNlIjogImRvY1sncG9wdWxhcml0eSddLnZhbHVlICogMC4xICsgZG9jWydyYXRpbmcnXS52YWx1ZSAqIDAuOSIKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>{
  &quot;query&quot;: {
    &quot;function_score&quot;: {
      &quot;query&quot;: {
        &quot;match_all&quot;: {}
      },
      &quot;script_score&quot;: {
        &quot;script&quot;: {
          &quot;source&quot;: &quot;doc['popularity'].value * 0.1 + doc['rating'].value * 0.9&quot;
        }
      }
    }
  }
}</pre></div><div class='content'></div><h2><p>Example 2: Conditional Updates</p>
</h2>
<div class='content'><p>Update documents conditionally based on a field value:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ewogICJzY3JpcHQiOiB7CiAgICAic291cmNlIjogImlmIChjdHguX3NvdXJjZS5zdGF0dXMgPT0gJ2FjdGl2ZScpIHsgY3R4Ll9zb3VyY2UuY291bnRlciArPSAxIH0iCiAgfQp9"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>{
  &quot;script&quot;: {
    &quot;source&quot;: &quot;if (ctx._source.status == 'active') { ctx._source.counter += 1 }&quot;
  }
}</pre></div><div class='content'></div><h2><p>Example 3: Custom Aggregations</p>
</h2>
<div class='content'><p>Perform a custom aggregation using a script:</p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ewogICJhZ2dzIjogewogICAgImN1c3RvbV9zdW0iOiB7CiAgICAgICJzY3JpcHRlZF9tZXRyaWMiOiB7CiAgICAgICAgImluaXRfc2NyaXB0IjogInN0YXRlLnRvdGFsID0gMCIsCiAgICAgICAgIm1hcF9zY3JpcHQiOiAic3RhdGUudG90YWwgKz0gZG9jWydmaWVsZF9uYW1lJ10udmFsdWUiLAogICAgICAgICJjb21iaW5lX3NjcmlwdCI6ICJyZXR1cm4gc3RhdGUudG90YWwiLAogICAgICAgICJyZWR1Y2Vfc2NyaXB0IjogImRvdWJsZSB0b3RhbCA9IDA7IGZvciAocyBpbiBzdGF0ZXMpIHsgdG90YWwgKz0gcyB9IHJldHVybiB0b3RhbCIKICAgICAgfQogICAgfQogIH0KfQ=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>{
  &quot;aggs&quot;: {
    &quot;custom_sum&quot;: {
      &quot;scripted_metric&quot;: {
        &quot;init_script&quot;: &quot;state.total = 0&quot;,
        &quot;map_script&quot;: &quot;state.total += doc['field_name'].value&quot;,
        &quot;combine_script&quot;: &quot;return state.total&quot;,
        &quot;reduce_script&quot;: &quot;double total = 0; for (s in states) { total += s } return total&quot;
      }
    }
  }
}</pre></div><div class='content'></div><h1><ol start="5">
<li>Security Considerations</li>
</ol>
</h1>
<div class='content'><p>Scripting can pose security risks if not properly managed. Here are some best practices:</p>
<ul>
<li><strong>Use Painless</strong>: It is designed to be secure and performant.</li>
<li><strong>Sandboxing</strong>: Ensure scripts run in a sandboxed environment.</li>
<li><strong>Limit Script Contexts</strong>: Restrict where scripts can be used (e.g., only in specific queries or updates).</li>
<li><strong>Audit Scripts</strong>: Regularly review and audit scripts for security vulnerabilities.</li>
</ul>
</div><h1><ol start="6">
<li>Exercises</li>
</ol>
</h1>
<div class='content'></div><h2><p>Exercise 1: Custom Scoring</p>
</h2>
<div class='content'><p>Create a query that uses a Painless script to calculate a custom score for documents based on the <code>views</code> and <code>likes</code> fields.</p>
<p><strong>Solution:</strong></p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ewogICJxdWVyeSI6IHsKICAgICJmdW5jdGlvbl9zY29yZSI6IHsKICAgICAgInF1ZXJ5IjogewogICAgICAgICJtYXRjaF9hbGwiOiB7fQogICAgICB9LAogICAgICAic2NyaXB0X3Njb3JlIjogewogICAgICAgICJzY3JpcHQiOiB7CiAgICAgICAgICAic291cmNlIjogImRvY1sndmlld3MnXS52YWx1ZSAqIDAuNSArIGRvY1snbGlrZXMnXS52YWx1ZSAqIDEuNSIKICAgICAgICB9CiAgICAgIH0KICAgIH0KICB9Cn0="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>{
  &quot;query&quot;: {
    &quot;function_score&quot;: {
      &quot;query&quot;: {
        &quot;match_all&quot;: {}
      },
      &quot;script_score&quot;: {
        &quot;script&quot;: {
          &quot;source&quot;: &quot;doc['views'].value * 0.5 + doc['likes'].value * 1.5&quot;
        }
      }
    }
  }
}</pre></div><div class='content'></div><h2><p>Exercise 2: Conditional Update</p>
</h2>
<div class='content'><p>Write a script to update the <code>status</code> field of documents to <code>inactive</code> if the <code>last_login</code> field is older than 30 days.</p>
<p><strong>Solution:</strong></p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ewogICJzY3JpcHQiOiB7CiAgICAic291cmNlIjogImlmIChkb2NbJ2xhc3RfbG9naW4nXS52YWx1ZSA8IEluc3RhbnQubm93KCkubWludXMoMzAsIENocm9ub1VuaXQuREFZUykpIHsgY3R4Ll9zb3VyY2Uuc3RhdHVzID0gJ2luYWN0aXZlJyB9IgogIH0KfQ=="))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>{
  &quot;script&quot;: {
    &quot;source&quot;: &quot;if (doc['last_login'].value &lt; Instant.now().minus(30, ChronoUnit.DAYS)) { ctx._source.status = 'inactive' }&quot;
  }
}</pre></div><div class='content'></div><h2><p>Exercise 3: Custom Aggregation</p>
</h2>
<div class='content'><p>Create a custom aggregation that calculates the sum of the <code>sales</code> field for documents.</p>
<p><strong>Solution:</strong></p>
</div><div style='position:relative'><a class='copy_button' href='#' onclick='navigator.clipboard.writeText(decodeURIComponent(escape(atob("ewogICJhZ2dzIjogewogICAgInRvdGFsX3NhbGVzIjogewogICAgICAic2NyaXB0ZWRfbWV0cmljIjogewogICAgICAgICJpbml0X3NjcmlwdCI6ICJzdGF0ZS50b3RhbCA9IDAiLAogICAgICAgICJtYXBfc2NyaXB0IjogInN0YXRlLnRvdGFsICs9IGRvY1snc2FsZXMnXS52YWx1ZSIsCiAgICAgICAgImNvbWJpbmVfc2NyaXB0IjogInJldHVybiBzdGF0ZS50b3RhbCIsCiAgICAgICAgInJlZHVjZV9zY3JpcHQiOiAiZG91YmxlIHRvdGFsID0gMDsgZm9yIChzIGluIHN0YXRlcykgeyB0b3RhbCArPSBzIH0gcmV0dXJuIHRvdGFsIgogICAgICB9CiAgICB9CiAgfQp9"))));alert("Copied!");return false;'><i class='bi bi-copy'></i></a><pre class='code'>{
  &quot;aggs&quot;: {
    &quot;total_sales&quot;: {
      &quot;scripted_metric&quot;: {
        &quot;init_script&quot;: &quot;state.total = 0&quot;,
        &quot;map_script&quot;: &quot;state.total += doc['sales'].value&quot;,
        &quot;combine_script&quot;: &quot;return state.total&quot;,
        &quot;reduce_script&quot;: &quot;double total = 0; for (s in states) { total += s } return total&quot;
      }
    }
  }
}</pre></div><div class='content'></div><h1><p>Conclusion</p>
</h1>
<div class='content'><p>In this section, we have learned about scripting in Elasticsearch, focusing on the Painless scripting language. We covered the basics of Painless, how to use it in queries and updates, and provided practical examples and exercises. Scripting is a powerful tool that can help you perform complex operations on your data, but it should be used with caution due to potential security risks. In the next module, we will delve into data modeling and index management.</p>
</div><div class='row navigation'>
	<div class='col-1 col-md-2'>
					<a href='03-03-aggregations' title="Aggregations">
				<span class="d-none d-md-inline">&#x25C4; Previous</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-left-square-fill"></i></span>
			</a>
			</div>
	<div class='col-10 col-md-8 text-center'>
			</div>
	<div class='col-1 col-md-2 text-end'>
					<a href='04-01-mapping-analyzers' title="Mapping and Analyzers">
				<span class="d-none d-md-inline">Next &#x25BA;</span>
				<span class="d-inline d-md-none"><i class="bi bi-caret-right-square-fill"></i></span>
			</a>
			</div>
</div>

			</div>
		</div>
		<div class="col-12 col-lg-4 publi" id="div_publi">
			<h1>Advertising</h1>
			<p>This space is reserved for advertising.</p>
			<p>If you want to be a sponsor, contact us to include links in this area: <a href='mailto:admin@campusempresa.cat'>admin@campusempresa.cat</a></p>
			<p>Thank you for collaborating!</p>
		</div>
	</div>
</div>

   <div class="container-xxl my-3">
	<div class="row">
		<div class="col">
			<footer>&copy; Copyright 2024. All rights reserved</footer>
		</div>
	</div>
</div>	

<div id="cookies_adv" style="display:none;">
	We use cookies to improve your user experience and offer content tailored to your interests.
    <a href="#" id="btn_accept_cookies" class="button">Accept</a>
    <a href="/cookies">More Information</a>
</div>	

	</div>    
</body>
</html>
